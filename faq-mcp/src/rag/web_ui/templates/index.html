<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TiDB Vector Document Processing System - Team Caffeine-Overflow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        [lang="zh"] {
            display: none;
        }
        
        body.lang-zh [lang="en"] {
            display: none;
        }
        
        body.lang-zh [lang="zh"] {
            display: inline-block;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .header {
            background-color: #3a3af1;
            padding: 15px 0;
            color: white;
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: none;
        }
        .card-header {
            background-color: #f1f1f1;
            font-weight: 600;
            border-radius: 8px 8px 0 0 !important;
        }
        .btn-primary {
            background-color: #3a3af1;
            border-color: #3a3af1;
        }
        .btn-primary:hover {
            background-color: #2929d9;
            border-color: #2929d9;
        }
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #3a3af1;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Custom file input styling */
        .custom-file-upload .btn {
            cursor: pointer;
        }
        
        .custom-file-upload .input-group-text {
            border-top-right-radius: 0.25rem;
            border-bottom-right-radius: 0.25rem;
            color: white;
        }
        
        #selected-files {
            max-height: 150px;
            overflow-y: auto;
        }
        
        #selected-files div {
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Fade-out animation */
        .fade {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
        
        /* Progress steps styling */
        #process-steps {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        
        #process-steps div {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e9ecef;
        }
        
        #process-steps div:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        #process-steps .text-success i,
        #process-steps .text-danger i {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 lang="en">TiDB Vector Document Processing System</h1>
                    <h1 lang="zh">TiDB Vector 文档处理系统</h1>
                    <p class="mb-0" lang="en">Convenient Document Vectorization and Retrieval Tool - Built by Team Caffeine-Overflow</p>
                    <p class="mb-0" lang="zh">便捷的文档向量化与检索工具 - 由 Caffeine-Overflow 团队构建</p>
                </div>
                <div>
                    <button id="lang-toggle" class="btn btn-outline-light">
                        <span lang="en">中文</span>
                        <span lang="zh">English</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mb-5">
        <!-- Security Notice -->
        <div class="alert alert-warning mb-4">
            <i class="bi bi-shield-lock"></i> 
            <strong lang="en">Security Notice:</strong>
            <strong lang="zh">安全提示：</strong> 
            <span lang="en">
                Sensitive information like TiDB connection strings and API keys are only used in the current session and will not be permanently stored.
                Please clear your browser cache after using this application in a shared environment.
            </span>
            <span lang="zh">
                本应用处理的 TiDB 连接字符串和 API 密钥等敏感信息仅在当前会话中使用，不会被永久存储。请确保在共享环境中使用后及时清除浏览器缓存。
            </span>
        </div>
        
        <!-- Database Connection Configuration -->
        <div class="card">
            <div class="card-header">
                <span lang="en">Database Connection</span>
                <span lang="zh">数据库连接配置</span>
            </div>
            <div class="card-body">
                <form id="connection-form">
                    <div class="mb-3 position-relative">
                        <label for="connection-string" class="form-label">
                            <span lang="en">TiDB Connection String</span>
                            <span lang="zh">TiDB 连接字符串</span>
                        </label>
                        <input type="password" class="form-control" id="connection-string" 
                               placeholder="e.g.: mysql+pymysql://username:password@host:port/dbname">
                        <i class="bi bi-eye-slash password-toggle" id="connection-toggle" onclick="togglePasswordVisibility('connection-string', 'connection-toggle')"></i>
                        <small class="form-text text-muted">
                            <span lang="en">Connection string contains sensitive information and will be securely handled</span>
                            <span lang="zh">连接字符串包含敏感信息，将被安全处理</span>
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span lang="en">Test Connection</span>
                        <span lang="zh">测试连接</span>
                    </button>
                </form>
                <div id="connection-status" class="status-message mt-3"></div>
            </div>
        </div>
        
        <!-- Table Management -->
        <div class="card">
            <div class="card-header">
                <span lang="en">Table Management</span>
                <span lang="zh">Table 管理</span>
            </div>
            <div class="card-body">
                <button id="list-tables-btn" class="btn btn-secondary mb-3">
                    <span lang="en">List Tables</span>
                    <span lang="zh">获取 Table 列表</span>
                </button>
                
                <div id="tables-container" class="table-container" style="display: none;">
                    <h5>
                        <span lang="en">Existing Tables:</span>
                        <span lang="zh">现有 Tables:</span>
                    </h5>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>
                                    <span lang="en">Table Name</span>
                                    <span lang="zh">Table 名</span>
                                </th>
                                <th>
                                    <span lang="en">Actions</span>
                                    <span lang="zh">操作</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tables-list">
                            <!-- Table list will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4">
                    <h5>
                        <span lang="en">Drop Table</span>
                        <span lang="zh">删除 Table</span>
                    </h5>
                    <div class="input-group mb-3">
                        <input type="text" id="table-to-drop" class="form-control" placeholder="Enter table name to drop">
                        <button class="btn btn-danger" id="drop-table-btn">
                            <span lang="en">Drop</span>
                            <span lang="zh">删除</span>
                        </button>
                    </div>
                    <div id="drop-status" class="status-message"></div>
                </div>
            </div>
        </div>
        
        <!-- Document Processing -->
        <div class="card">
            <div class="card-header">
                <span lang="en">Document Processing</span>
                <span lang="zh">文档处理</span>
            </div>
            <div class="card-body">
                <form id="document-form">
                    <div class="mb-3">
                        <label for="table-name" class="form-label">
                            <span lang="en">Table Name</span>
                            <span lang="zh">Table 名称</span>
                        </label>
                        <input type="text" class="form-control" id="table-name" placeholder="Create a new table name for document vectors">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <span lang="en">API Key Type</span>
                            <span lang="zh">API密钥类型</span>
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="api-key-type" id="openai-api" value="openai" checked>
                            <label class="form-check-label" for="openai-api">
                                OpenAI API
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="api-key-type" id="google-api" value="google">
                            <label class="form-check-label" for="google-api">
                                Google API
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3 position-relative">
                        <label for="api-key" class="form-label">
                            <span lang="en">API Key</span>
                            <span lang="zh">API密钥</span>
                        </label>
                        <input type="password" class="form-control" id="api-key" placeholder="Enter your API key">
                        <i class="bi bi-eye-slash password-toggle" id="api-key-toggle" onclick="togglePasswordVisibility('api-key', 'api-key-toggle')"></i>
                        <small class="form-text text-muted">
                            <span lang="en">API key is sensitive information, only used during the session and not permanently stored</span>
                            <span lang="zh">API密钥是敏感信息，仅在会话期间使用，不会被永久存储</span>
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <span lang="en">Document Source</span>
                            <span lang="zh">文档来源</span>
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="docs-source" id="upload-files" value="upload" checked>
                            <label class="form-check-label" for="upload-files">
                                <span lang="en">Upload Files</span>
                                <span lang="zh">上传文件</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="docs-source" id="specify-directory" value="directory">
                            <label class="form-check-label" for="specify-directory">
                                <span lang="en">Specify Directory</span>
                                <span lang="zh">指定目录</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="upload-files-container" class="mb-3">
                        <label for="files" class="form-label">
                            <span lang="en">Upload Files (supports .md, .txt, .pdf)</span>
                            <span lang="zh">上传文件 (支持 .md, .txt, .pdf)</span>
                        </label>
                        <div class="custom-file-upload">
                            <div class="input-group">
                                <input type="text" class="form-control" id="file-path-display" readonly placeholder="No files selected" disabled>
                                <label class="input-group-text btn btn-primary" for="files">
                                    <span lang="en">Browse...</span>
                                    <span lang="zh">浏览...</span>
                                </label>
                            </div>
                            <input class="form-control d-none" type="file" id="files" multiple>
                            <div id="selected-files" class="mt-2 small text-muted"></div>
                        </div>
                    </div>
                    
                    <div id="specify-directory-container" class="mb-3" style="display: none;">
                        <label for="docs-dir" class="form-label">
                            <span lang="en">Document Directory Path</span>
                            <span lang="zh">文档目录路径</span>
                        </label>
                        <input type="text" class="form-control" id="docs-dir" placeholder="Enter absolute path of document directory on server">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <span lang="en">Process Documents</span>
                        <span lang="zh">处理文档</span>
                    </button>
                </form>
                <div id="process-status" class="status-message mt-3"></div>
            </div>
        </div>
        
        <!-- Retrieval Test -->
        <div class="card">
            <div class="card-header">
                <span lang="en">Retrieval Test</span>
                <span lang="zh">检索测试</span>
            </div>
            <div class="card-body">
                <form id="retrieval-form">
                    <div class="mb-3">
                        <label for="retrieval-table" class="form-label">
                            <span lang="en">Table Name</span>
                            <span lang="zh">Table 名称</span>
                        </label>
                        <input type="text" class="form-control" id="retrieval-table" placeholder="Enter table name to query">
                    </div>
                    
                    <div class="mb-3">
                        <label for="query" class="form-label">
                            <span lang="en">Query</span>
                            <span lang="zh">查询</span>
                        </label>
                        <input type="text" class="form-control" id="query" placeholder="Enter query content">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="k-results" class="form-label">
                                <span lang="en">Number of Results (k)</span>
                                <span lang="zh">结果数量 (k)</span>
                            </label>
                            <input type="number" class="form-control" id="k-results" value="3" min="1" max="10">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="threshold" class="form-label">
                                <span lang="en">Similarity Threshold</span>
                                <span lang="zh">相似度阈值</span>
                            </label>
                            <input type="number" class="form-control" id="threshold" value="0.5" min="0" max="1" step="0.1">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <span lang="en">Execute Query</span>
                        <span lang="zh">执行查询</span>
                    </button>
                </form>
                <div id="retrieval-status" class="status-message mt-3"></div>
                <div id="retrieval-results" class="mt-3" style="display: none;">
                    <h5>
                        <span lang="en">Query Results:</span>
                        <span lang="zh">查询结果:</span>
                    </h5>
                    <pre id="results-content"></pre>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>
                        <span lang="en">TiDB Vector Document Processing System</span>
                        <span lang="zh">TiDB Vector 文档处理系统</span>
                        &copy; 2025
                    </p>
                    <p class="small text-muted">
                        <span lang="en">Developed with ❤️ by Team Caffeine-Overflow</span>
                        <span lang="zh">由 Caffeine-Overflow 团队开发</span>
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>
                        <i class="bi bi-shield-check"></i> 
                        <span lang="en">Data Security</span>
                        <span lang="zh">数据安全保障</span>
                        | <i class="bi bi-gear"></i> 
                        <span lang="en">Version</span>
                        <span lang="zh">系统版本</span>
                        1.0.0
                    </p>
                    <p class="small text-muted">
                        <i class="bi bi-github"></i> 
                        <a href="https://github.com/wuhuizuo/caffeine-overflow" target="_blank">
                            <span lang="en">github.com/wuhuizuo/caffeine-overflow</span>
                            <span lang="zh">github.com/wuhuizuo/caffeine-overflow</span>
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Language toggle functionality
        function setLanguage(lang) {
            if (lang === 'zh') {
                document.body.classList.add('lang-zh');
                localStorage.setItem('language', 'zh');
            } else {
                document.body.classList.remove('lang-zh');
                localStorage.setItem('language', 'en');
            }
        }
        
        // Initialize language from local storage or default to English
        document.addEventListener('DOMContentLoaded', function() {
            const savedLang = localStorage.getItem('language') || 'en';
            setLanguage(savedLang);
            
            // Set up language toggle button
            document.getElementById('lang-toggle').addEventListener('click', function() {
                const currentLang = localStorage.getItem('language') || 'en';
                const newLang = currentLang === 'en' ? 'zh' : 'en';
                setLanguage(newLang);
            });
            
            // Initialize file input placeholder
            const filePathDisplay = document.getElementById('file-path-display');
            if (filePathDisplay) {
                const currentLang = localStorage.getItem('language') || 'en';
                filePathDisplay.placeholder = currentLang === 'en' ? 'No files selected' : '未选择任何文件';
            }
            
            // 切换密码显示/隐藏功能
            function togglePasswordVisibility(inputId, toggleId) {
                const input = document.getElementById(inputId);
                const toggle = document.getElementById(toggleId);
                
                if (input.type === 'password') {
                    input.type = 'text';
                    toggle.classList.replace('bi-eye-slash', 'bi-eye');
                } else {
                    input.type = 'password';
                    toggle.classList.replace('bi-eye', 'bi-eye-slash');
                }
            }
            
            // 切换文档来源
            document.querySelectorAll('input[name="docs-source"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'upload') {
                        document.getElementById('upload-files-container').style.display = 'block';
                        document.getElementById('specify-directory-container').style.display = 'none';
                    } else {
                        document.getElementById('upload-files-container').style.display = 'none';
                        document.getElementById('specify-directory-container').style.display = 'block';
                    }
                });
            });
            
            // 测试数据库连接
            document.getElementById('connection-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const connectionString = document.getElementById('connection-string').value;
                const statusElement = document.getElementById('connection-status');
                
                if (!connectionString) {
                    showStatus(statusElement, getLocalizedMessage(
                        'Please enter a connection string', 
                        '请输入连接字符串'
                    ), false);
                    return;
                }
                
                showStatus(statusElement, '<div class="loading"></div> ' + 
                    getLocalizedMessage(
                        'Testing connection...', 
                        '正在测试连接...'
                    ), true, 'info');
                
                const formData = new FormData();
                formData.append('connection_string', connectionString);
                
                fetch('/api/ping_tidb', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(statusElement, data.message, true);
                    } else {
                        showStatus(statusElement, data.message, false);
                    }
                })
                .catch(error => {
                    showStatus(statusElement, '连接测试失败: ' + error, false);
                });
            });
            
            // 获取表格列表
            document.getElementById('list-tables-btn').addEventListener('click', function() {
                const tablesContainer = document.getElementById('tables-container');
                const tablesList = document.getElementById('tables-list');
                
                tablesList.innerHTML = '<tr><td colspan="2"><div class="loading"></div> ' + 
                    getLocalizedMessage('Loading tables...', '正在获取 Table 列表...') + '</td></tr>';
                tablesContainer.style.display = 'block';
                
                fetch('/api/list_tables')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        tablesList.innerHTML = '';
                        
                        if (data.tables.length === 0) {
                            tablesList.innerHTML = '<tr><td colspan="2">' + 
                                getLocalizedMessage('No tables found', '没有找到 Table') + '</td></tr>';
                        } else {
                            data.tables.forEach(table => {
                                const row = document.createElement('tr');
                                
                                const nameCell = document.createElement('td');
                                nameCell.textContent = table;
                                
                                const actionCell = document.createElement('td');
                                
                                const useButton = document.createElement('button');
                                useButton.className = 'btn btn-sm btn-primary';
                                useButton.innerHTML = '<span lang="en">Use</span><span lang="zh">使用</span>';
                                useButton.addEventListener('click', function() {
                                    document.getElementById('retrieval-table').value = table;
                                    
                                    // Add table name to document processing form as well
                                    document.getElementById('table-name').value = table;
                                    
                                    // Show feedback message
                                    const tableMessage = getLocalizedMessage(
                                        `Table "${table}" selected for use. You can now use this table for document processing or queries.`,
                                        `已选择表 "${table}" 用于操作。您现在可以使用此表进行文档处理或查询。`
                                    );
                                    
                                    // Show success notification
                                    const notification = document.createElement('div');
                                    notification.className = 'alert alert-success mt-3';
                                    notification.innerHTML = `
                                        <i class="bi bi-check-circle"></i> ${tableMessage}
                                        <p class="mb-0 mt-2 small">
                                            <i class="bi bi-info-circle"></i> 
                                            <span lang="en">This table has been set for both retrieval testing and document processing. You can now:</span>
                                            <span lang="zh">此表已设置用于检索测试和文档处理。您现在可以：</span>
                                        </p>
                                        <ul class="small mb-0">
                                            <li>
                                                <span lang="en">Query existing data in this table</span>
                                                <span lang="zh">查询此表中的现有数据</span>
                                            </li>
                                            <li>
                                                <span lang="en">Add more documents to this table</span>
                                                <span lang="zh">向此表添加更多文档</span>
                                            </li>
                                        </ul>
                                    `;
                                    
                                    // Add temporary fade-out effect
                                    setTimeout(() => {
                                        document.getElementById('tables-container').appendChild(notification);
                                        
                                        // Apply language setting to new element
                                        const currentLang = localStorage.getItem('language') || 'en';
                                        setLanguage(currentLang);
                                        
                                        // Automatically scroll to the notification
                                        notification.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        
                                        // Remove notification after 10 seconds
                                        setTimeout(() => {
                                            notification.classList.add('fade');
                                            setTimeout(() => {
                                                if (notification.parentNode) {
                                                    notification.parentNode.removeChild(notification);
                                                }
                                            }, 500);
                                        }, 10000);
                                    }, 100);
                                });
                                
                                actionCell.appendChild(useButton);
                                
                                row.appendChild(nameCell);
                                row.appendChild(actionCell);
                                
                                tablesList.appendChild(row);
                            });
                            
                            // Apply language setting to the newly created elements
                            const currentLang = localStorage.getItem('language') || 'en';
                            setLanguage(currentLang);
                        }
                    } else {
                        tablesList.innerHTML = `<tr><td colspan="2" class="text-danger">${data.message}</td></tr>`;
                    }
                })
                .catch(error => {
                    tablesList.innerHTML = `<tr><td colspan="2" class="text-danger">` + 
                        getLocalizedMessage(
                            `Error loading tables: ${error}`,
                            `获取 Table 列表失败: ${error}`
                        ) + '</td></tr>';
                });
            });
            
            // 删除表格
            document.getElementById('drop-table-btn').addEventListener('click', function() {
                const tableName = document.getElementById('table-to-drop').value;
                const statusElement = document.getElementById('drop-status');
                
                if (!tableName) {
                    showStatus(statusElement, getLocalizedMessage(
                        'Please enter a table name', 
                        '请输入 Table 名称'
                    ), false);
                    return;
                }
                
                const confirmMessage = getLocalizedMessage(
                    `Are you sure you want to drop table "${tableName}"? This action cannot be undone.`,
                    `确定要删除 Table "${tableName}" 吗？这个操作不可撤销。`
                );
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                showStatus(statusElement, '<div class="loading"></div> ' + 
                    getLocalizedMessage(
                        'Dropping table...', 
                        '正在删除 Table...'
                    ), true, 'info');
                
                const formData = new FormData();
                formData.append('table_name', tableName);
                
                fetch('/api/drop_table', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(statusElement, data.message, true);
                        document.getElementById('list-tables-btn').click(); // 刷新表格列表
                    } else {
                        showStatus(statusElement, data.message, false);
                    }
                })
                .catch(error => {
                    showStatus(statusElement, '删除表格失败: ' + error, false);
                });
            });
            
            // 处理文档
            document.getElementById('document-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const tableName = document.getElementById('table-name').value;
                const apiKeyType = document.querySelector('input[name="api-key-type"]:checked').value;
                const apiKey = document.getElementById('api-key').value;
                const docsSource = document.querySelector('input[name="docs-source"]:checked').value;
                
                const statusElement = document.getElementById('process-status');
                
                if (!tableName) {
                    showStatus(statusElement, getLocalizedMessage(
                        'Please enter a table name',
                        '请输入 Table 名称'
                    ), false);
                    return;
                }
                
                if (!apiKey) {
                    showStatus(statusElement, getLocalizedMessage(
                        'Please enter an API key',
                        '请输入 API 密钥'
                    ), false);
                    return;
                }
                
                const formData = new FormData();
                formData.append('table_name', tableName);
                formData.append('api_key_type', apiKeyType);
                formData.append('api_key', apiKey);
                
                if (docsSource === 'upload') {
                    const files = document.getElementById('files').files;
                    
                    if (files.length === 0) {
                        showStatus(statusElement, getLocalizedMessage(
                            'Please select at least one file',
                            '请选择至少一个文件'
                        ), false);
                        return;
                    }
                    
                    for (let i = 0; i < files.length; i++) {
                        formData.append('files[]', files[i]);
                    }
                } else {
                    const docsDir = document.getElementById('docs-dir').value;
                    
                    if (!docsDir) {
                        showStatus(statusElement, getLocalizedMessage(
                            'Please enter a document directory path',
                            '请输入文档目录路径'
                        ), false);
                        return;
                    }
                    
                    formData.append('docs_dir', docsDir);
                }
                
                showStatus(statusElement, '<div class="loading"></div> ' + getLocalizedMessage(
                    'Processing documents... This may take some time',
                    '正在处理文档...这可能需要一些时间'
                ), true, 'info');
                
                // Add progress container
                const progressContainer = document.createElement('div');
                progressContainer.id = 'progress-container';
                progressContainer.className = 'mt-3 border rounded p-3 bg-light';
                progressContainer.innerHTML = `
                    <div class="mb-2">
                        <span lang="en">Processing Progress:</span>
                        <span lang="zh">处理进度:</span>
                    </div>
                    <div class="progress mb-3">
                        <div id="process-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
                    </div>
                    <div id="process-steps" class="small text-muted">
                        <div><i class="bi bi-hourglass-split"></i> <span lang="en">Initializing...</span><span lang="zh">初始化中...</span></div>
                    </div>
                `;
                statusElement.after(progressContainer);
                
                // Apply language setting to new element
                const currentLang = localStorage.getItem('language') || 'en';
                setLanguage(currentLang);
                
                // Set up progress tracking
                const progressBar = document.getElementById('process-progress-bar');
                const processSteps = document.getElementById('process-steps');
                
                // Simulate progress updates for better UX
                let currentStep = 0;
                const totalSteps = docsSource === 'upload' ? 5 : 4;
                
                // Step descriptions in both languages
                const steps = [
                    { en: 'Initializing document processing...', zh: '初始化文档处理...' },
                    { en: 'Uploading files to server...', zh: '上传文件至服务器...' },
                    { en: 'Loading and parsing documents...', zh: '加载并解析文档...' },
                    { en: 'Generating vector embeddings...', zh: '生成向量嵌入...' },
                    { en: 'Storing data in TiDB Vector...', zh: '将数据存储至 TiDB Vector...' },
                    { en: 'Processing complete!', zh: '处理完成！' }
                ];
                
                // Function to update progress
                function updateProgress(step, complete = false) {
                    currentStep = step;
                    const percent = Math.round((step / totalSteps) * 100);
                    progressBar.style.width = `${percent}%`;
                    progressBar.setAttribute('aria-valuenow', percent);
                    progressBar.textContent = `${percent}%`;
                    
                    // Add step to the steps display
                    const stepMessage = getLocalizedMessage(steps[step].en, steps[step].zh);
                    const icon = complete ? 'bi-check-circle-fill text-success' : 'bi-hourglass-split';
                    
                    // Create step element
                    const stepElement = document.createElement('div');
                    stepElement.innerHTML = `<i class="bi ${icon}"></i> ${stepMessage}`;
                    
                    // Add new step
                    processSteps.appendChild(stepElement);
                    
                    // Scroll to the bottom of the steps list
                    processSteps.scrollTop = processSteps.scrollHeight;
                }
                
                // Initialize with first step
                updateProgress(0);
                
                // Progress simulation (the actual progress would ideally come from the server)
                const progressTimer = setInterval(() => {
                    if (currentStep < totalSteps - 1) {
                        updateProgress(currentStep + 1);
                    } else {
                        clearInterval(progressTimer);
                    }
                }, docsSource === 'upload' ? 3000 : 2000); // Slightly faster for directory processing
                
                fetch('/api/upload_documents', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Clear the progress timer
                    clearInterval(progressTimer);
                    
                    // Update to completion state
                    updateProgress(totalSteps, true);
                    progressBar.classList.remove('progress-bar-animated');
                    
                    if (data.success) {
                        // Update the last step to completed
                        const completeMsg = getLocalizedMessage(
                            'All documents processed successfully!',
                            '所有文档处理成功！'
                        );
                        const finishElement = document.createElement('div');
                        finishElement.className = 'text-success';
                        finishElement.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${completeMsg}`;
                        processSteps.appendChild(finishElement);
                        
                        // Add summary 
                        const summaryElement = document.createElement('div');
                        summaryElement.className = 'alert alert-success mt-3';
                        
                        let summaryMsg = getLocalizedMessage(
                            `Successfully processed ${formData.getAll('files[]').length} document(s) into table "${tableName}"`,
                            `成功将 ${formData.getAll('files[]').length} 个文档处理到表 "${tableName}" 中`
                        );
                        
                        if (docsSource === 'directory') {
                            summaryMsg = getLocalizedMessage(
                                `Successfully processed documents from "${formData.get('docs_dir')}" into table "${tableName}"`,
                                `成功将目录 "${formData.get('docs_dir')}" 中的文档处理到表 "${tableName}" 中`
                            );
                        }
                        
                        summaryElement.innerHTML = `<i class="bi bi-info-circle"></i> ${summaryMsg}`;
                        processSteps.after(summaryElement);
                        
                        // Show success status
                        showStatus(statusElement, data.message, true);
                        
                        // Refresh table list
                        document.getElementById('list-tables-btn').click();
                    } else {
                        // Show error in progress steps
                        const errorMsg = getLocalizedMessage(
                            'Error during processing: ' + data.message,
                            '处理过程中出错: ' + data.message
                        );
                        const errorElement = document.createElement('div');
                        errorElement.className = 'text-danger';
                        errorElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${errorMsg}`;
                        processSteps.appendChild(errorElement);
                        
                        // Show error status
                        showStatus(statusElement, data.message, false);
                    }
                })
                .catch(error => {
                    // Clear the progress timer
                    clearInterval(progressTimer);
                    
                    // Show error in progress steps
                    const errorMsg = getLocalizedMessage(
                        'Error processing documents: ' + error,
                        '处理文档失败: ' + error
                    );
                    const errorElement = document.createElement('div');
                    errorElement.className = 'text-danger';
                    errorElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${errorMsg}`;
                    processSteps.appendChild(errorElement);
                    
                    // Update progress bar to error state
                    progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                    progressBar.classList.add('bg-danger');
                    
                    showStatus(statusElement, getLocalizedMessage(
                        'Error processing documents: ' + error,
                        '处理文档失败: ' + error
                    ), false);
                });
            });
            
            // 检索测试
            document.getElementById('retrieval-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const tableName = document.getElementById('retrieval-table').value;
                const query = document.getElementById('query').value;
                const k = document.getElementById('k-results').value;
                const threshold = document.getElementById('threshold').value;
                const apiKeyType = document.querySelector('input[name="api-key-type"]:checked').value;
                const apiKey = document.getElementById('api-key').value;
                
                const statusElement = document.getElementById('retrieval-status');
                const resultsElement = document.getElementById('retrieval-results');
                const resultsContent = document.getElementById('results-content');
                
                if (!tableName) {
                    showStatus(statusElement, getLocalizedMessage(
                        'Please enter a table name',
                        '请输入 Table 名称'
                    ), false);
                    return;
                }
                
                if (!query) {
                    showStatus(statusElement, getLocalizedMessage(
                        'Please enter a query',
                        '请输入查询内容'
                    ), false);
                    return;
                }
                
                if (!apiKey) {
                    showStatus(statusElement, getLocalizedMessage(
                        'Please enter an API key',
                        '请输入 API 密钥'
                    ), false);
                    return;
                }
                
                showStatus(statusElement, '<div class="loading"></div> ' + getLocalizedMessage(
                    'Executing query...',
                    '正在执行查询...'
                ), true, 'info');
                resultsElement.style.display = 'none';
                
                const formData = new FormData();
                formData.append('table_name', tableName);
                formData.append('query', query);
                formData.append('k', k);
                formData.append('threshold', threshold);
                formData.append('api_key_type', apiKeyType);
                formData.append('api_key', apiKey);
                
                fetch('/api/test_retrieval', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(statusElement, getLocalizedMessage(
                            'Query successful',
                            '查询成功'
                        ), true);
                        resultsContent.textContent = data.results.join('\n');
                        resultsElement.style.display = 'block';
                    } else {
                        showStatus(statusElement, data.message, false);
                        resultsElement.style.display = 'none';
                    }
                })
                .catch(error => {
                    showStatus(statusElement, getLocalizedMessage(
                        'Error executing query: ' + error,
                        '执行查询失败: ' + error
                    ), false);
                    resultsElement.style.display = 'none';
                });
            });
            
            // 辅助函数：显示状态消息
            function showStatus(element, message, isSuccess, type) {
                element.innerHTML = message;
                element.style.display = 'block';
                
                // 移除所有类
                element.classList.remove('success', 'error', 'info');
                
                // 添加适当的类
                if (type === 'info') {
                    element.classList.add('info');
                } else if (isSuccess) {
                    element.classList.add('success');
                } else {
                    element.classList.add('error');
                }
            }
            
            // Helper function to get localized messages
            function getLocalizedMessage(enMessage, zhMessage) {
                const currentLang = localStorage.getItem('language') || 'en';
                return currentLang === 'en' ? enMessage : zhMessage;
            }
            
            // Handle custom file input
            document.getElementById('files').addEventListener('change', function() {
                const fileInput = this;
                const filePathDisplay = document.getElementById('file-path-display');
                const selectedFilesContainer = document.getElementById('selected-files');
                const currentLang = localStorage.getItem('language') || 'en';
                
                if (fileInput.files.length === 0) {
                    // No files selected
                    filePathDisplay.value = '';
                    filePathDisplay.placeholder = currentLang === 'en' ? 'No files selected' : '未选择任何文件';
                    selectedFilesContainer.innerHTML = '';
                } else {
                    // Files selected
                    const filesSelectedText = currentLang === 'en' 
                        ? `${fileInput.files.length} file(s) selected`
                        : `已选择 ${fileInput.files.length} 个文件`;
                        
                    filePathDisplay.value = filesSelectedText;
                    
                    // Show list of files if multiple
                    if (fileInput.files.length > 0) {
                        let filesHtml = '';
                        for (let i = 0; i < fileInput.files.length; i++) {
                            filesHtml += `<div><i class="bi bi-file-earmark-text"></i> ${fileInput.files[i].name}</div>`;
                        }
                        selectedFilesContainer.innerHTML = filesHtml;
                    } else {
                        selectedFilesContainer.innerHTML = '';
                    }
                }
            });
            
            // Localize placeholders and update them when language changes
            function updatePlaceholders() {
                const currentLang = localStorage.getItem('language') || 'en';
                
                // Update placeholders based on current language
                document.getElementById('connection-string').placeholder = 
                    currentLang === 'en' 
                        ? 'e.g.: mysql+pymysql://username:password@host:port/dbname'
                        : '例如: mysql+pymysql://username:password@host:port/dbname';
                
                document.getElementById('table-to-drop').placeholder = 
                    currentLang === 'en' ? 'Enter table name to drop' : '输入要删除的 Table 名称';
                
                document.getElementById('table-name').placeholder = 
                    currentLang === 'en' ? 'Create a new table name for document vectors' : '为文档向量创建新的 Table 名称';
                
                document.getElementById('api-key').placeholder = 
                    currentLang === 'en' ? 'Enter your API key' : '输入API密钥';
                
                document.getElementById('docs-dir').placeholder = 
                    currentLang === 'en' ? 'Enter absolute path of document directory on server' : '输入服务器上的文档目录绝对路径';
                
                document.getElementById('retrieval-table').placeholder = 
                    currentLang === 'en' ? 'Enter table name to query' : '输入要查询的 Table 名称';
                
                document.getElementById('query').placeholder = 
                    currentLang === 'en' ? 'Enter query content' : '输入查询内容';
                
                // Update file input placeholder
                const filePathDisplay = document.getElementById('file-path-display');
                if (filePathDisplay && !filePathDisplay.value) {
                    filePathDisplay.placeholder = currentLang === 'en' ? 'No files selected' : '未选择任何文件';
                }
                
                // Update file selected text if files are selected
                const fileInput = document.getElementById('files');
                if (fileInput && fileInput.files.length > 0) {
                    const filesSelectedText = currentLang === 'en' 
                        ? `${fileInput.files.length} file(s) selected`
                        : `已选择 ${fileInput.files.length} 个文件`;
                    document.getElementById('file-path-display').value = filesSelectedText;
                }
            }
            
            // Add event listener to update placeholders when language changes
            document.getElementById('lang-toggle').addEventListener('click', updatePlaceholders);
            
            // Initialize placeholders
            updatePlaceholders();
        });
    </script>
</body>
</html> 